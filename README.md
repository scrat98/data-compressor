# How to use

Compile with maven ``mvn clean package`` or download from [github](https://github.com/scrat98/data-compressor/releases) and execute the jar  
``java -jar data-compressor.jar <encode | decode> <input file> <output file>``

# Project structure
Есть интерфейс ``Compressor``, которые реализуют соответствующие алгоритмы. Все алгоритмы разбиты по пакетам с их названием. Каждый компрессор проверяется на наборе файлов и случайном наборе байт, что он может закодировать и декодировать без ошибок.  
Класс ``DataCompressor`` включает в себя цепочку компрессоров и поочередно их вызывает.

# Algorithm explanation

Сначала был реализован алгоритм Адаптивного Арифметического кодирования. Затем "компрессор" улучшался. В итоге, вся цепочка компрессора состоит из: ``RLE <-> BWT <-> MTF <-> RLE <-> A0``.
Стоит заметить, что файл не выгружается целиком в память(во избежание проблем) и каждый следующий алгоритм читает временный файл предыдущего алгоритма. Т.е. данный архиватор является полностью адаптивным.  
С итоговым сравнением эффективности разных цепочек алгоритмов вы можете ознакомиться [здесь](#overall-result). Ниже будут описаны краткие детали каждого из алгоритмов

## Arithmetic coding
Энтропийный алгоритм сжатия, который основан на частоте символов. За основу была взята статья Witten'а. Данный метод основан на целочисленной реализации. 
Также в данной реализации не передается размер файла, а вводиться дополнительный символ окончания потока(EOF), т.е. расширяется алфавит и число интервалов, на которые делится отрезок.
Тем самым делая алгоритм адаптивным. Частота символов вычисляется динамически по их приходу и увеличивает соответствующий счетчик.

Источники:
- Witten, I.H., Neal, R., and Cleary, J.G., (1987b) “Arithmetic coding for data compression,” Communications of the Association for Computing Machinery,30 (6) 520-540, June.
- https://neerc.ifmo.ru/wiki/index.php?title=%D0%90%D1%80%D0%B8%D1%84%D0%BC%D0%B5%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5_%D0%BA%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5
- https://habr.com/ru/post/130531/

## BWT

Данное преобразование позволяет преобразовать исходный поток в поток повторяющихся подстрок.  
Кодирование и декодирование происходит на блоке байт равному 200кБайт  

*Кодирование*:  
В данной реализации добавляется искусственно дополнительный символ конца строки(EOF), который является лексикографически большим любого символа.
Это позволяет использовать префиксную сортировку, основанную на индексах. В данной реализации использована стандартная сортировка TeamSort в Java, которая работает в среднем за O(n), а в худшем за O(n*log n).  

Таким образом закодированная строка выглядит следующим образом ``bytes_size | [data] | first_index | eof_index``. 
Где byteSize - размер блока данных, firstIndex - это номер исходной строки, eofIndex - индекс символа конца строки. 
Тем самым мы добавляем дополнительно 3 * 4(на указатели) + 1(на EOF) = 13 байт на каждый блок данных, но это дает нам возможность кодировать за линейное время и не считывать весь файл в память.

*Декодирование*:  
Используется метод вектора обратного преобразования. Работает за линейное время

Источники:
- https://www.youtube.com/watch?v=4n7NPk5lwbI
- https://www.quora.com/Algorithms/How-can-I-optimize-burrows-wheeler-transform-and-inverse-transform-to-work-in-O-n-time-O-n-space
- https://neerc.ifmo.ru/wiki/index.php?title=%D0%9F%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%91%D0%B0%D1%80%D1%80%D0%BE%D1%83%D0%B7%D0%B0-%D0%A3%D0%B8%D0%BB%D0%B5%D1%80%D0%B0
- https://compression.ru/book/pdf/compression_methods_part1_5-7.pdf
- http://mf.grsu.by/UchProc/livak/po/comprsite/theory_bwt.html

## MTF

Алгоритм позволяет после BWT превратить поток в поток повторяющихся байт. Этот подход используется в bzip2. Реализован без каких либо модификаций.

Источники:
- http://neerc.ifmo.ru/wiki/index.php?title=%D0%9F%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_MTF

## RLE
Поточный алгоритм сжатия. Можно сказать, является наивной реализацией алгоритмов семейства LZ*. Он позволяет сжимать повторяющиеся серии символов. Под максимальную длину серии был взят размер 1 байта.
Было рассмотрено два варианта реализации:
1) В первом байте хранить длину и если она отрицательная, то значит следующие n символов не являются серией и мы их просто считываем, если положительная, то будет следовать n повторений следующего символа.
Была сделана маленькая оптимизация, что длины повторяющихся цепочек хранились от 2 до 129, так как минимальная цепочка имеет длину 2.  
``ABCABCABCDDDFFFFFF -> -9ABCABCABC3D6F``

2) Мы пишем символы и если встретили повторяющиеся, то после них пишем длину еще повторений этих же символов. ``ABCAAA -> ABCAA1``
Это плохо работает только со строками, где много серий длины два, тогда мы каждый раз увеличиваем длину файла на 1 байт(``AA -> AA0``), но это нивелируется следующими алгоритмами BWT и MTF.  

Второй вариант реализации оказался более эффективным.

Этот алгоритм применяется до BWT, чтобы сделать более быструю сортировку впоследствии. И после MTF, так как образуется много нулей после него.

Источники:
- https://habr.com/ru/post/141827/
- https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%BB%D0%B8%D0%BD_%D1%81%D0%B5%D1%80%D0%B8%D0%B9

## TODO
Заменить алгоритм RLE на LZW/LZ77, что даст прирост в качестве сжатия/

# Performance test results
For tests we are going to use [Calgary group dataset](http://www.data-compression.info/Corpora/CalgaryCorpus/)

## Entropy for files
|  |
|

## A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 72789 | 5.234 | 60 |
| book1 | 768771 | 436883 | 4.546 | 291 |
| book2 | 610856 | 364720 | 4.777 | 504 |
| geo | 102400 | 72400 | 5.656 | 111 |
| news | 377109 | 244471 | 5.186 | 430 |
| obj1 | 21504 | 16038 | 5.967 | 13 |
| obj2 | 246814 | 187294 | 6.071 | 684 |
| paper1 | 53161 | 33120 | 4.984 | 75 |
| paper2 | 82199 | 47534 | 4.626 | 93 |
| paper3 | 46526 | 27393 | 4.710 | 19 |
| paper4 | 13286 | 7998 | 4.816 | 5 |
| paper5 | 11954 | 7559 | 5.059 | 4 |
| paper6 | 38105 | 23832 | 5.003 | 15 |
| pic | 513216 | 74804 | 1.166 | 175 |
| progc | 39611 | 25920 | 5.235 | 60 |
| progl | 71646 | 42619 | 4.759 | 128 |
| progp | 49379 | 30209 | 4.894 | 53 |
| trans | 93695 | 64326 | 5.492 | 80 |
| total | 3251493 | 1779909 | 88.181 | 2800 |

## BWT <-> MTF <-> A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 31978 | 2.299 | 82 |
| book1 | 768771 | 278160 | 2.895 | 907 |
| book2 | 610856 | 189975 | 2.488 | 562 |
| geo | 102400 | 67009 | 5.235 | 209 |
| news | 377109 | 137617 | 2.919 | 796 |
| obj1 | 21504 | 11585 | 4.310 | 35 |
| obj2 | 246814 | 85852 | 2.783 | 275 |
| paper1 | 53161 | 17980 | 2.706 | 67 |
| paper2 | 82199 | 27566 | 2.683 | 51 |
| paper3 | 46526 | 17250 | 2.966 | 61 |
| paper4 | 13286 | 5517 | 3.322 | 15 |
| paper5 | 11954 | 5080 | 3.400 | 25 |
| paper6 | 38105 | 13222 | 2.776 | 53 |
| pic | 513216 | 63045 | 0.983 | 1169 |
| progc | 39611 | 13546 | 2.736 | 26 |
| progl | 71646 | 17285 | 1.930 | 545 |
| progp | 49379 | 11754 | 1.904 | 65 |
| trans | 93695 | 19431 | 1.659 | 97 |
| total | 3251493 | 1013852 | 49.993 | 5040 |

## RLE <-> BWT <-> MTF <-> A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 32234 | 2.318 | 76 |
| book1 | 768771 | 281169 | 2.926 | 750 |
| book2 | 610856 | 192471 | 2.521 | 513 |
| geo | 102400 | 67064 | 5.239 | 118 |
| news | 377109 | 138581 | 2.940 | 301 |
| obj1 | 21504 | 11363 | 4.227 | 17 |
| obj2 | 246814 | 86327 | 2.798 | 196 |
| paper1 | 53161 | 18161 | 2.733 | 36 |
| paper2 | 82199 | 27858 | 2.711 | 56 |
| paper3 | 46526 | 17380 | 2.988 | 30 |
| paper4 | 13286 | 5593 | 3.368 | 12 |
| paper5 | 11954 | 5160 | 3.453 | 8 |
| paper6 | 38105 | 13398 | 2.813 | 24 |
| pic | 513216 | 53929 | 0.841 | 94 |
| progc | 39611 | 13788 | 2.785 | 25 |
| progl | 71646 | 17515 | 1.956 | 70 |
| progp | 49379 | 11829 | 1.916 | 35 |
| trans | 93695 | 19643 | 1.677 | 104 |
| total | 3251493 | 1013463 | 50.210 | 2465 |

## BWT <-> MTF <-> RLE <-> A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 29390 | 2.113 | 79 |
| book1 | 768771 | 274650 | 2.858 | 618 |
| book2 | 610856 | 184455 | 2.416 | 913 |
| geo | 102400 | 62501 | 4.883 | 599 |
| news | 377109 | 133331 | 2.828 | 329 |
| obj1 | 21504 | 10835 | 4.031 | 24 |
| obj2 | 246814 | 81732 | 2.649 | 226 |
| paper1 | 53161 | 17617 | 2.651 | 33 |
| paper2 | 82199 | 26843 | 2.612 | 59 |
| paper3 | 46526 | 16918 | 2.909 | 94 |
| paper4 | 13286 | 5482 | 3.301 | 35 |
| paper5 | 11954 | 5077 | 3.398 | 9 |
| paper6 | 38105 | 13036 | 2.737 | 26 |
| pic | 513216 | 54765 | 0.854 | 1822 |
| progc | 39611 | 13233 | 2.673 | 46 |
| progl | 71646 | 16850 | 1.881 | 77 |
| progp | 49379 | 11523 | 1.867 | 125 |
| trans | 93695 | 19155 | 1.636 | 59 |
| total | 3251493 | 977393 | 48.297 | 5173 |

## RLE <-> BWT <-> MTF <-> RLE <-> A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 29565 | 2.126 | 189 |
| book1 | 768771 | 275913 | 2.871 | 787 |
| book2 | 610856 | 185719 | 2.432 | 651 |
| geo | 102400 | 62646 | 4.894 | 134 |
| news | 377109 | 134014 | 2.843 | 329 |
| obj1 | 21504 | 10871 | 4.044 | 27 |
| obj2 | 246814 | 82111 | 2.661 | 217 |
| paper1 | 53161 | 17720 | 2.667 | 34 |
| paper2 | 82199 | 26953 | 2.623 | 70 |
| paper3 | 46526 | 16993 | 2.922 | 62 |
| paper4 | 13286 | 5528 | 3.329 | 16 |
| paper5 | 11954 | 5135 | 3.437 | 11 |
| paper6 | 38105 | 13158 | 2.762 | 37 |
| pic | 513216 | 51044 | 0.796 | 141 |
| progc | 39611 | 13309 | 2.688 | 26 |
| progl | 71646 | 16685 | 1.863 | 82 |
| progp | 49379 | 11402 | 1.847 | 44 |
| trans | 93695 | 19297 | 1.648 | 72 |
| total | 3251493 | 978063 | 48.453 | 2929 |

## Overall result
| Type | Total compressed(bytes) | Total bits per byte | Total elapsed time(ms) | (raw - compressed)/elapsed time ratio |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| A0 | 1779909 | 88.181 | 5007 | 293 |
| BWT <-> MTF <-> A0 | 1013852 | 49.993 | 20208 | 110 |
| RLE <-> BWT <-> MTF <-> A0 | 1013463 | 50.210 | 13301 | 168 |
| BWT <-> MTF <-> RLE <-> A0 | 977393 | 48.297 | 9433 | 241 |
| RLE <-> BWT <-> MTF <-> RLE <-> A0 | 978063 | 48.453 | 4565 | 498 |