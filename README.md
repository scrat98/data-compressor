# How to use

Compile with maven ``mvn clean package`` or download from [github](https://github.com/scrat98/data-compressor/releases) and execute the jar  
``java -jar data-compressor.jar <encode | decode> <input file> <output file>``

# Project structure
Есть интерфейс ``Compressor``, которые реализуют соответствующие алгоритмы. Все алгоритмы разбиты по пакетам с их названием. Каждый компрессор проверяется на наборе файлов и случайном наборе байт, что он может закодировать и декодировать без ошибок.  
Класс ``DataCompressor`` включает в себя цепочку компрессоров и поочередно их вызывает.

# Algorithm explanation

Сначала был реализован алгоритм Адаптивного Арифметического кодирования. Затем "компрессор" улучшался. В итоге, вся цепочка компрессора состоит из: ``RLE <-> BWT <-> MTF <-> RLE <-> A0``.
Стоит заметить, что файл не выгружается целиком в память(во избежание проблем) и каждый следующий алгоритм читает временный файл предыдущего алгоритма. Т.е. данный архиватор является полностью адаптивным.  
С итоговым сравнением эффективности разных цепочек алгоритмов вы можете ознакомиться [здесь](#overall-result). Ниже будут описаны краткие детали каждого из алгоритмов

## Arithmetic coding
Энтропийный алгоритм сжатия, который основан на частоте символов. За основу была взята статья Witten'а. Данный метод основан на целочисленной реализации. 
Также в данной реализации не передается размер файла, а вводиться дополнительный символ окончания потока(EOF), т.е. расширяется алфавит и число интервалов, на которые делится отрезок.
Тем самым делая алгоритм адаптивным. Частота символов вычисляется динамически по их приходу и увеличивает соответствующий счетчик.

Источники:
- Witten, I.H., Neal, R., and Cleary, J.G., (1987b) “Arithmetic coding for data compression,” Communications of the Association for Computing Machinery,30 (6) 520-540, June.
- https://neerc.ifmo.ru/wiki/index.php?title=%D0%90%D1%80%D0%B8%D1%84%D0%BC%D0%B5%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5_%D0%BA%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5
- https://habr.com/ru/post/130531/

## BWT

Данное преобразование позволяет преобразовать исходный поток в поток повторяющихся подстрок.  
Кодирование и декодирование происходит на блоке байт равному 200кБайт  

*Кодирование*:  
В данной реализации добавляется искусственно дополнительный символ конца строки(EOF), который является лексикографически большим любого символа.
Это позволяет использовать префиксную сортировку, основанную на индексах. В данной реализации использована стандартная сортировка TimSort в Java, которая работает в среднем за O(n), а в худшем за O(n*log n).  

Таким образом закодированная строка выглядит следующим образом ``bytes_size | [data] | first_index | eof_index``. 
Где byteSize - размер блока данных, firstIndex - это номер исходной строки, eofIndex - индекс символа конца строки. 
Тем самым мы добавляем дополнительно 3 * 4(на указатели) + 1(на EOF) = 13 байт на каждый блок данных, но это дает нам возможность кодировать за линейное время и не считывать весь файл в память.

*Декодирование*:  
Используется метод вектора обратного преобразования. Работает за линейное время

Источники:
- https://www.youtube.com/watch?v=4n7NPk5lwbI
- https://www.quora.com/Algorithms/How-can-I-optimize-burrows-wheeler-transform-and-inverse-transform-to-work-in-O-n-time-O-n-space
- https://neerc.ifmo.ru/wiki/index.php?title=%D0%9F%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%91%D0%B0%D1%80%D1%80%D0%BE%D1%83%D0%B7%D0%B0-%D0%A3%D0%B8%D0%BB%D0%B5%D1%80%D0%B0
- https://compression.ru/book/pdf/compression_methods_part1_5-7.pdf
- http://mf.grsu.by/UchProc/livak/po/comprsite/theory_bwt.html

## MTF

Алгоритм позволяет после BWT превратить поток в поток повторяющихся байт. Этот подход используется в bzip2. Реализован без каких либо модификаций.

Источники:
- http://neerc.ifmo.ru/wiki/index.php?title=%D0%9F%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_MTF

## RLE
Поточный алгоритм сжатия. Можно сказать, является наивной реализацией алгоритмов семейства LZ*. Он позволяет сжимать повторяющиеся серии символов. Под максимальную длину серии был взят размер 1 байта.
Было рассмотрено два варианта реализации:
1) В первом байте хранить длину и если она отрицательная, то значит следующие n символов не являются серией и мы их просто считываем, если положительная, то будет следовать n повторений следующего символа.
Была сделана маленькая оптимизация, что длины повторяющихся цепочек хранились от 2 до 129, так как минимальная цепочка имеет длину 2.  
``ABCABCABCDDDFFFFFF -> -9ABCABCABC3D6F``

2) Мы пишем символы и если встретили повторяющиеся, то после них пишем длину еще повторений этих же символов. ``ABCAAA -> ABCAA1``
Это плохо работает только со строками, где много серий длины два, тогда мы каждый раз увеличиваем длину файла на 1 байт(``AA -> AA0``), но это нивелируется следующими алгоритмами BWT и MTF.  

Второй вариант реализации оказался более эффективным.

Этот алгоритм применяется до BWT, чтобы сделать более быструю сортировку впоследствии. И после MTF, так как образуется много нулей после него.

Источники:
- https://habr.com/ru/post/141827/
- https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B4%D0%BB%D0%B8%D0%BD_%D1%81%D0%B5%D1%80%D0%B8%D0%B9

## TODO
Заменить алгоритм RLE на LZW/LZ77, что даст прирост в качестве сжатия

# Performance test results
For tests we are going to use [Calgary group dataset](http://www.data-compression.info/Corpora/CalgaryCorpus/)

## Entropy for files
| File name   | H(X)        | H(X \| X)   | H(X \| XX)  | 
| ----------- | ----------- | ----------- | ----------- |
| bib         | 5.2007      | 3.3641      | 2.3075      |
| book1       | 4.5271      | 3.5845      | 2.8141      |
| book2       | 4.7926      | 3.7452      | 2.7357      |
| geo         | 5.6464      | 4.2642      | 3.4578      |
| news        | 5.1896      | 4.0919      | 2.9228      |
| obj1        | 5.9482      | 3.4636      | 1.4005      |
| obj2        | 6.2604      | 3.8704      | 2.2654      |
| paper1      | 4.9830      | 3.6461      | 2.3318      |
| paper2      | 4.6014      | 3.5224      | 2.5136      |
| pic         | 1.2102      | 0.8237      | 0.7052      |
| progc       | 5.1990      | 3.6034      | 2.1340      |
| progl       | 4.7701      | 3.2116      | 2.0435      |
| progp       | 4.8688      | 3.1875      | 1.7551      |
| trans       | 5.5328      | 3.3548      | 1.9305      |

## A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 72789 | 5.234 | 100 |
| book1 | 768771 | 436883 | 4.546 | 639 |
| book2 | 610856 | 364720 | 4.777 | 474 |
| geo | 102400 | 72400 | 5.656 | 220 |
| news | 377109 | 244471 | 5.186 | 497 |
| obj1 | 21504 | 16038 | 5.967 | 41 |
| obj2 | 246814 | 187294 | 6.071 | 345 |
| paper1 | 53161 | 33120 | 4.984 | 57 |
| paper2 | 82199 | 47534 | 4.626 | 86 |
| pic | 513216 | 74804 | 1.166 | 132 |
| progc | 39611 | 25920 | 5.235 | 29 |
| progl | 71646 | 42619 | 4.759 | 290 |
| progp | 49379 | 30209 | 4.894 | 54 |
| trans | 93695 | 64326 | 5.492 | 124 |
| total | 3141622 | 1713127 | 68.593 | 3088 |

## BWT <-> MTF <-> A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 31978 | 2.299 | 132 |
| book1 | 768771 | 278160 | 2.895 | 784 |
| book2 | 610856 | 189975 | 2.488 | 628 |
| geo | 102400 | 67009 | 5.235 | 217 |
| news | 377109 | 137617 | 2.919 | 856 |
| obj1 | 21504 | 11585 | 4.310 | 45 |
| obj2 | 246814 | 85852 | 2.783 | 285 |
| paper1 | 53161 | 17980 | 2.706 | 71 |
| paper2 | 82199 | 27566 | 2.683 | 67 |
| pic | 513216 | 63045 | 0.983 | 1130 |
| progc | 39611 | 13546 | 2.736 | 31 |
| progl | 71646 | 17285 | 1.930 | 248 |
| progp | 49379 | 11754 | 1.904 | 45 |
| trans | 93695 | 19431 | 1.659 | 84 |
| total | 3141622 | 972783 | 37.530 | 4623 |

## RLE <-> BWT <-> MTF <-> A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 32234 | 2.318 | 125 |
| book1 | 768771 | 281169 | 2.926 | 860 |
| book2 | 610856 | 192471 | 2.521 | 588 |
| geo | 102400 | 67064 | 5.239 | 159 |
| news | 377109 | 138581 | 2.940 | 541 |
| obj1 | 21504 | 11363 | 4.227 | 36 |
| obj2 | 246814 | 86327 | 2.798 | 237 |
| paper1 | 53161 | 18161 | 2.733 | 66 |
| paper2 | 82199 | 27858 | 2.711 | 99 |
| pic | 513216 | 53929 | 0.841 | 144 |
| progc | 39611 | 13788 | 2.785 | 31 |
| progl | 71646 | 17515 | 1.956 | 83 |
| progp | 49379 | 11829 | 1.916 | 44 |
| trans | 93695 | 19643 | 1.677 | 79 |
| total | 3141622 | 971932 | 37.588 | 3092 |

## BWT <-> MTF <-> RLE <-> A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 29390 | 2.113 | 74 |
| book1 | 768771 | 274650 | 2.858 | 761 |
| book2 | 610856 | 184455 | 2.416 | 499 |
| geo | 102400 | 62501 | 4.883 | 172 |
| news | 377109 | 133331 | 2.828 | 433 |
| obj1 | 21504 | 10835 | 4.031 | 26 |
| obj2 | 246814 | 81732 | 2.649 | 235 |
| paper1 | 53161 | 17617 | 2.651 | 35 |
| paper2 | 82199 | 26843 | 2.612 | 86 |
| pic | 513216 | 54765 | 0.854 | 1153 |
| progc | 39611 | 13233 | 2.673 | 63 |
| progl | 71646 | 16850 | 1.881 | 43 |
| progp | 49379 | 11523 | 1.867 | 63 |
| trans | 93695 | 19155 | 1.636 | 59 |
| total | 3141622 | 936880 | 35.952 | 3702 |

## RLE <-> BWT <-> MTF <-> RLE <-> A0
| File name | Raw size(bytes) | Compressed size(bytes) | Bits per byte | Elapsed time(ms) |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| bib | 111261 | 29565 | 2.126 | 110 |
| book1 | 768771 | 275913 | 2.871 | 740 |
| book2 | 610856 | 185719 | 2.432 | 525 |
| geo | 102400 | 62646 | 4.894 | 272 |
| news | 377109 | 134014 | 2.843 | 360 |
| obj1 | 21504 | 10871 | 4.044 | 18 |
| obj2 | 246814 | 82111 | 2.661 | 400 |
| paper1 | 53161 | 17720 | 2.667 | 81 |
| paper2 | 82199 | 26953 | 2.623 | 125 |
| pic | 513216 | 51044 | 0.796 | 202 |
| progc | 39611 | 13309 | 2.688 | 84 |
| progl | 71646 | 16685 | 1.863 | 46 |
| progp | 49379 | 11402 | 1.847 | 56 |
| trans | 93695 | 19297 | 1.648 | 78 |
| total | 3141622 | 937249 | 36.004 | 3097 |

## Overall result
| Type | Total compressed(bytes) | Total bits per byte | Total elapsed time(ms) | (raw - compressed)/elapsed time ratio |
| ----------- | ----------- | ----------- | ----------- | ----------- |
| A0 | 1713127 | 68.593 | 3088 | 462 |
| BWT <-> MTF <-> A0 | 972783 | 37.530 | 4623 | 469 |
| RLE <-> BWT <-> MTF <-> A0 | 971932 | 37.588 | 3092 | 701 |
| BWT <-> MTF <-> RLE <-> A0 | 936880 | 35.952 | 3702 | 595 |
| RLE <-> BWT <-> MTF <-> RLE <-> A0 | 937249 | 36.004 | 3097 | 711 |