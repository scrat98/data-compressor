# How to use  
Compile with maven ``mvn clean package`` or download from [github](https://github.com/scrat98/data-compressor/releases) and execute the jar    
``java -jar jpeg-compressor.jar <encode | decode> <input file> <output file>``  
  
# Project structure  
Все находится в пакете ``jpeg``. Есть интерфейс ``JpegCompressor``, которые реализуют соответствующие стратегии сжатия. 
В пакете ``entropy.coding`` реализовано арифметическое и Хаффман энтропийное кодирование
  
# Algorithm explanation  
``GenericJpegCompressor`` писался по принципу от простого к сложному. Он использует несколько стратегий сжатия и в первом байте записывает стратегию.    
0 - ``None``    
1 - ``Base``    
2 - ``Simple``    
3 - ``JpegTranscoder``    

Ниже о каждой стратегии сжатия  

## BaseJpegCompressor  
Исходный jpeg просто сжимается с использованием ``DataCompressor``. Но так как в jpeg уже применен RLE, то последовательность алгоритмов следующая ``BWT <-> MTF <-> RLE <-> A0``
  
### Quality 30

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| airplane30.jpg | 19207 | 18848 | 1.869 |
| tulips30.jpg | 37972 | 37860 | 0.295 |
| serrano30.jpg | 58288 | 57441 | 1.453 |
| girl30.jpg | 24310 | 23564 | 3.069 |
| lena30.jpg | 17578 | 17476 | 0.580 |
| baboon30.jpg | 36113 | 36010 | 0.285 |
| cat30.jpg | 35902 | 35854 | 0.134 |
| sails30.jpg | 45512 | 45226 | 0.628 |
| monarch30.jpg | 28501 | 28227 | 0.961 |
| arctichare30.jpg | 12080 | 11443 | 5.273 |
| fruits30.jpg | 17646 | 17529 | 0.663 |
| frymire30.jpg | 200860 | 194597 | 3.118 |
| watch30.jpg | 46741 | 44444 | 4.914 |
| peppers30.jpg | 18746 | 18659 | 0.464 |
| pool30.jpg | 7467 | 6195 | 17.035 |
| total | 606923 | 593373 | 2.233 |

### Quality 80

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| cat80.jpg | 81974 | 81993 | -0.023 |
| monarch80.jpg | 64055 | 64103 | -0.075 |
| tulips80.jpg | 85764 | 85870 | -0.124 |
| lena80.jpg | 43872 | 43860 | 0.027 |
| peppers80.jpg | 47929 | 47893 | 0.075 |
| serrano80.jpg | 138167 | 136961 | 0.873 |
| sails80.jpg | 105830 | 105896 | -0.062 |
| airplane80.jpg | 44079 | 44075 | 0.009 |
| baboon80.jpg | 88465 | 88514 | -0.055 |
| watch80.jpg | 101074 | 99901 | 1.161 |
| arctichare80.jpg | 26569 | 26270 | 1.125 |
| girl80.jpg | 59979 | 59643 | 0.560 |
| pool80.jpg | 14492 | 13803 | 4.754 |
| frymire80.jpg | 440857 | 435317 | 1.257 |
| fruits80.jpg | 45303 | 45348 | -0.099 |
| total | 1388409 | 1379447 | 0.645 |

## SimpleJpegCompressor  
В исходном jpeg извлекается энтропийная дата(сжатая Хаффманом) и сжимается тем же ``DataCompressor``. Заголовки не сжимаются

### Quality 30

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| airplane30.jpg | 19207 | 19012 | 1.015 |
| tulips30.jpg | 37972 | 38062 | -0.237 |
| serrano30.jpg | 58288 | 57659 | 1.079 |
| girl30.jpg | 24310 | 23751 | 2.299 |
| lena30.jpg | 17578 | 17634 | -0.319 |
| baboon30.jpg | 36113 | 36141 | -0.078 |
| cat30.jpg | 35902 | 36042 | -0.390 |
| sails30.jpg | 45512 | 45415 | 0.213 |
| monarch30.jpg | 28501 | 28462 | 0.137 |
| arctichare30.jpg | 12080 | 11592 | 4.040 |
| fruits30.jpg | 17646 | 17675 | -0.164 |
| frymire30.jpg | 200860 | 195040 | 2.898 |
| watch30.jpg | 46741 | 44691 | 4.386 |
| peppers30.jpg | 18746 | 18789 | -0.229 |
| pool30.jpg | 7467 | 6337 | 15.133 |
| total | 606923 | 596302 | 1.750 |

### Quality 80

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| cat80.jpg | 81974 | 82244 | -0.329 |
| monarch80.jpg | 64055 | 64343 | -0.450 |
| tulips80.jpg | 85764 | 86144 | -0.443 |
| lena80.jpg | 43872 | 44013 | -0.321 |
| peppers80.jpg | 47929 | 48033 | -0.217 |
| serrano80.jpg | 138167 | 137209 | 0.693 |
| sails80.jpg | 105830 | 106172 | -0.323 |
| airplane80.jpg | 44079 | 44252 | -0.392 |
| baboon80.jpg | 88465 | 88773 | -0.348 |
| watch80.jpg | 101074 | 100301 | 0.765 |
| arctichare80.jpg | 26569 | 26447 | 0.459 |
| girl80.jpg | 59979 | 59818 | 0.268 |
| pool80.jpg | 14492 | 13955 | 3.705 |
| frymire80.jpg | 440857 | 435997 | 1.102 |
| fruits80.jpg | 45303 | 45499 | -0.433 |
| total | 1388409 | 1383200 | 0.375 |

## JpegTranscoder  
В данной стратегии декодируется Хаффман (rle и дельта кодирование остается) и кодируется адаптивным арифметическим кодером(только symbol1, как и Хаффман делает).
Для этих целей был написан свой кодер и декодер Хаффмана, а также парсер jpeg метаданных.   

Подходы, которые также были протестированы:
- Был рассмотрен случай арифметического кодирования, но если учесть, что при таком подходе нам нужно еще передавать матрицу вероятностей для символов, то в итоге этот метод проигрывал адаптивному.  
- Если пробовать сжать раскодированный хафманом последовательность байт целиком(symbol1 и symbol2 не разделять), то сжатия вовсе не будет и файл только увеличивается в объеме. 
Было протестировано на ``DataCompressor``, ``Deflate`` и ``PPMD``.  

Идеи:
- использовать разные таблицы вероятностей для AC и DC коэффициентов в случае арифметического кодирования и посмотреть на результаты

### Quality 30

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| airplane30.jpg | 19207 | 18976 | 1.203 |
| tulips30.jpg | 37972 | 38132 | -0.421 |
| serrano30.jpg | 58288 | 58156 | 0.226 |
| girl30.jpg | 24310 | 23525 | 3.229 |
| lena30.jpg | 17578 | 17468 | 0.626 |
| baboon30.jpg | 36113 | 35783 | 0.914 |
| cat30.jpg | 35902 | 36357 | -1.267 |
| sails30.jpg | 45512 | 45230 | 0.620 |
| monarch30.jpg | 28501 | 28510 | -0.032 |
| arctichare30.jpg | 12080 | 11776 | 2.517 |
| fruits30.jpg | 17646 | 17270 | 2.131 |
| frymire30.jpg | 200860 | 200773 | 0.043 |
| watch30.jpg | 46741 | 45664 | 2.304 |
| peppers30.jpg | 18746 | 18618 | 0.683 |
| pool30.jpg | 7467 | 7010 | 6.120 |
| total | 606923 | 603248 | 0.606 |

### Quality 80

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| cat80.jpg | 81974 | 82911 | -1.143 |
| monarch80.jpg | 64055 | 64775 | -1.124 |
| tulips80.jpg | 85764 | 86734 | -1.131 |
| lena80.jpg | 43872 | 44590 | -1.637 |
| peppers80.jpg | 47929 | 48357 | -0.893 |
| serrano80.jpg | 138167 | 137628 | 0.390 |
| sails80.jpg | 105830 | 107118 | -1.217 |
| airplane80.jpg | 44079 | 44691 | -1.388 |
| baboon80.jpg | 88465 | 89248 | -0.885 |
| watch80.jpg | 101074 | 102433 | -1.345 |
| arctichare80.jpg | 26569 | 27238 | -2.518 |
| girl80.jpg | 59979 | 60479 | -0.834 |
| pool80.jpg | 14492 | 14802 | -2.139 |
| frymire80.jpg | 440857 | 437707 | 0.715 |
| fruits80.jpg | 45303 | 45961 | -1.452 |
| total | 1388409 | 1394672 | -0.451 |

## Сжатие квантованных DCT коэффициентов  
Был рассмотрен вариант, при котором мы декодируем до квантованных DCT коэффициентов(тем самым увеличиваем данные больше чем в два раза по сравнению с закодированным rle и дельтой коэффициентами). 
Матрица была получено с помощью [jpeglib-turbo](https://github.com/libjpeg-turbo/libjpeg-turbo).  

Были рассмотрены варианта сжатия ``Deflater``, ``PPMD`` и ``DataCompressor``, но ничто не дало должных результатов. 
От сюда можно сделать вывод, что rle и дельта, которая используются в jpeg, это неотъемлемая часть и нужно смотреть в сторону более эффективных энтропийных кодеров.
Также были рассмотрены методы последовательного кодирования коэффициентов, а не зигзагообразного, но тоже не дало результатов.
  
## Результаты  

Итоговые результаты ``GenericJpegCompressor``, который выбирает лучшую стратегию сжатия.

### Quality 30

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| airplane30.jpg | 19207 | 18849 | 1.864 |
| tulips30.jpg | 37972 | 37861 | 0.292 |
| serrano30.jpg | 58288 | 57442 | 1.451 |
| girl30.jpg | 24310 | 23526 | 3.225 |
| lena30.jpg | 17578 | 17469 | 0.620 |
| baboon30.jpg | 36113 | 35784 | 0.911 |
| cat30.jpg | 35902 | 35855 | 0.131 |
| sails30.jpg | 45512 | 45227 | 0.626 |
| monarch30.jpg | 28501 | 28228 | 0.958 |
| arctichare30.jpg | 12080 | 11444 | 5.265 |
| fruits30.jpg | 17646 | 17271 | 2.125 |
| frymire30.jpg | 200860 | 194598 | 3.118 |
| watch30.jpg | 46741 | 44445 | 4.912 |
| peppers30.jpg | 18746 | 18619 | 0.677 |
| pool30.jpg | 7467 | 6196 | 17.022 |
| total | 606923 | 592814 | 2.325 |

### Quality 80

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| cat80.jpg | 81974 | 81975 | -0.001 |
| monarch80.jpg | 64055 | 64056 | -0.002 |
| tulips80.jpg | 85764 | 85765 | -0.001 |
| lena80.jpg | 43872 | 43861 | 0.025 |
| peppers80.jpg | 47929 | 47894 | 0.073 |
| serrano80.jpg | 138167 | 136962 | 0.872 |
| sails80.jpg | 105830 | 105831 | -0.001 |
| airplane80.jpg | 44079 | 44076 | 0.007 |
| baboon80.jpg | 88465 | 88466 | -0.001 |
| watch80.jpg | 101074 | 99902 | 1.160 |
| arctichare80.jpg | 26569 | 26271 | 1.122 |
| girl80.jpg | 59979 | 59644 | 0.559 |
| pool80.jpg | 14492 | 13804 | 4.747 |
| frymire80.jpg | 440857 | 435318 | 1.256 |
| fruits80.jpg | 45303 | 45304 | -0.002 |
| total | 1388409 | 1379129 | 0.668 |