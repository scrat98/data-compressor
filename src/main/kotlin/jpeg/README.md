# How to use  
Compile with maven ``mvn clean package`` or download from [github](https://github.com/scrat98/data-compressor/releases) and execute the jar    
``java -jar jpeg-compressor.jar <encode | decode> <input file> <output file>``  
  
# Project structure  
Все находится в пакете ``jpeg``. Есть интерфейс ``JpegCompressor``, которые реализуют соответствующие стратегии сжатия. 
В пакете ``entropy.coding`` реализовано арифметическое и Хаффман энтропийное кодирование
  
# Algorithm explanation  
``GenericJpegCompressor`` писался по принципу от простого к сложному. Он использует несколько стратегий сжатия и в первом байте записывает стратегию.    
0 - ``None``    
1 - ``Base``    
2 - ``Simple``    
3 - ``JpegTranscoder``    

Ниже о каждой стратегии сжатия  

## BaseJpegCompressor  
Исходный jpeg просто сжимается с использованием ``DataCompressor``. Но так как в jpeg уже применен RLE, то последовательность алгоритмов следующая ``BWT <-> MTF <-> RLE <-> A0``
  
### Quality 30

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| airplane30.jpg | 19207 | 18848 | 1.869 |
| tulips30.jpg | 37972 | 37860 | 0.295 |
| serrano30.jpg | 58288 | 57441 | 1.453 |
| girl30.jpg | 24310 | 23564 | 3.069 |
| lena30.jpg | 17578 | 17476 | 0.580 |
| baboon30.jpg | 36113 | 36010 | 0.285 |
| cat30.jpg | 35902 | 35854 | 0.134 |
| sails30.jpg | 45512 | 45226 | 0.628 |
| monarch30.jpg | 28501 | 28227 | 0.961 |
| arctichare30.jpg | 12080 | 11443 | 5.273 |
| fruits30.jpg | 17646 | 17529 | 0.663 |
| frymire30.jpg | 200860 | 194597 | 3.118 |
| watch30.jpg | 46741 | 44444 | 4.914 |
| peppers30.jpg | 18746 | 18659 | 0.464 |
| pool30.jpg | 7467 | 6195 | 17.035 |
| total | 606923 | 593373 | 2.233 |

### Quality 80

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| cat80.jpg | 81974 | 81993 | -0.023 |
| monarch80.jpg | 64055 | 64103 | -0.075 |
| tulips80.jpg | 85764 | 85870 | -0.124 |
| lena80.jpg | 43872 | 43860 | 0.027 |
| peppers80.jpg | 47929 | 47893 | 0.075 |
| serrano80.jpg | 138167 | 136961 | 0.873 |
| sails80.jpg | 105830 | 105896 | -0.062 |
| airplane80.jpg | 44079 | 44075 | 0.009 |
| baboon80.jpg | 88465 | 88514 | -0.055 |
| watch80.jpg | 101074 | 99901 | 1.161 |
| arctichare80.jpg | 26569 | 26270 | 1.125 |
| girl80.jpg | 59979 | 59643 | 0.560 |
| pool80.jpg | 14492 | 13803 | 4.754 |
| frymire80.jpg | 440857 | 435317 | 1.257 |
| fruits80.jpg | 45303 | 45348 | -0.099 |
| total | 1388409 | 1379447 | 0.645 |

## SimpleJpegCompressor  
В исходном jpeg извлекается энтропийная дата(сжатая Хаффманом) и сжимается тем же ``DataCompressor``. Заголовки не сжимаются

### Quality 30

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| airplane30.jpg | 19207 | 19012 | 1.015 |
| tulips30.jpg | 37972 | 38062 | -0.237 |
| serrano30.jpg | 58288 | 57659 | 1.079 |
| girl30.jpg | 24310 | 23751 | 2.299 |
| lena30.jpg | 17578 | 17634 | -0.319 |
| baboon30.jpg | 36113 | 36141 | -0.078 |
| cat30.jpg | 35902 | 36042 | -0.390 |
| sails30.jpg | 45512 | 45415 | 0.213 |
| monarch30.jpg | 28501 | 28462 | 0.137 |
| arctichare30.jpg | 12080 | 11592 | 4.040 |
| fruits30.jpg | 17646 | 17675 | -0.164 |
| frymire30.jpg | 200860 | 195040 | 2.898 |
| watch30.jpg | 46741 | 44691 | 4.386 |
| peppers30.jpg | 18746 | 18789 | -0.229 |
| pool30.jpg | 7467 | 6337 | 15.133 |
| total | 606923 | 596302 | 1.750 |

### Quality 80

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| cat80.jpg | 81974 | 82244 | -0.329 |
| monarch80.jpg | 64055 | 64343 | -0.450 |
| tulips80.jpg | 85764 | 86144 | -0.443 |
| lena80.jpg | 43872 | 44013 | -0.321 |
| peppers80.jpg | 47929 | 48033 | -0.217 |
| serrano80.jpg | 138167 | 137209 | 0.693 |
| sails80.jpg | 105830 | 106172 | -0.323 |
| airplane80.jpg | 44079 | 44252 | -0.392 |
| baboon80.jpg | 88465 | 88773 | -0.348 |
| watch80.jpg | 101074 | 100301 | 0.765 |
| arctichare80.jpg | 26569 | 26447 | 0.459 |
| girl80.jpg | 59979 | 59818 | 0.268 |
| pool80.jpg | 14492 | 13955 | 3.705 |
| frymire80.jpg | 440857 | 435997 | 1.102 |
| fruits80.jpg | 45303 | 45499 | -0.433 |
| total | 1388409 | 1383200 | 0.375 |

## JpegTranscoder  
В данной стратегии декодируется Хаффман (rle и дельта кодирование остается) и кодируется адаптивным арифметическим кодером(только symbol1, как и Хаффман делает).
Для этих целей был написан свой кодер и декодер Хаффмана, а также парсер jpeg метаданных.   

Подходы, которые также были протестированы:
- Был рассмотрен случай арифметического кодирования, но если учесть, что при таком подходе нам нужно еще передавать матрицу вероятностей для символов, то в итоге этот метод проигрывал адаптивному.  
- Если пробовать сжать раскодированный хафманом последовательность байт целиком(symbol1 и symbol2 не разделять), то сжатия вовсе не будет и файл только увеличивается в объеме. 
Было протестировано на ``DataCompressor``, ``Deflate`` и ``PPMD``.  

Идеи:
- использовать разные таблицы вероятностей для AC и DC коэффициентов в случае арифметического кодирования и посмотреть на результаты

### Quality 30

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| airplane30.jpg | 19207 | 18986 | 1.151 |
| tulips30.jpg | 37972 | 37556 | 1.096 |
| serrano30.jpg | 58288 | 57163 | 1.930 |
| girl30.jpg | 24310 | 23228 | 4.451 |
| lena30.jpg | 17578 | 17440 | 0.785 |
| baboon30.jpg | 36113 | 35368 | 2.063 |
| cat30.jpg | 35902 | 35526 | 1.047 |
| sails30.jpg | 45512 | 44459 | 2.314 |
| monarch30.jpg | 28501 | 28447 | 0.189 |
| arctichare30.jpg | 12080 | 11943 | 1.134 |
| fruits30.jpg | 17646 | 17375 | 1.536 |
| frymire30.jpg | 200860 | 197375 | 1.735 |
| watch30.jpg | 46741 | 44309 | 5.203 |
| peppers30.jpg | 18746 | 18649 | 0.517 |
| pool30.jpg | 7467 | 7588 | -1.620 |
| total | 606923 | 595412 | 1.897 |

### Quality 80

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| cat80.jpg | 81974 | 81420 | 0.676 |
| monarch80.jpg | 64055 | 64211 | -0.244 |
| tulips80.jpg | 85764 | 85440 | 0.378 |
| lena80.jpg | 43872 | 44019 | -0.335 |
| peppers80.jpg | 47929 | 47827 | 0.213 |
| serrano80.jpg | 138167 | 135521 | 1.915 |
| sails80.jpg | 105830 | 105759 | 0.067 |
| airplane80.jpg | 44079 | 44457 | -0.858 |
| baboon80.jpg | 88465 | 88303 | 0.183 |
| watch80.jpg | 101074 | 100678 | 0.392 |
| arctichare80.jpg | 26569 | 27264 | -2.616 |
| girl80.jpg | 59979 | 59858 | 0.202 |
| pool80.jpg | 14492 | 14937 | -3.071 |
| frymire80.jpg | 440857 | 431110 | 2.211 |
| fruits80.jpg | 45303 | 45610 | -0.678 |
| total | 1388409 | 1376414 | 0.864 |

## Сжатие квантованных DCT коэффициентов  
Был рассмотрен вариант, при котором мы декодируем до квантованных DCT коэффициентов(тем самым увеличиваем данные больше чем в два раза по сравнению с закодированным rle и дельтой коэффициентами). 
Матрица была получено с помощью [jpeglib-turbo](https://github.com/libjpeg-turbo/libjpeg-turbo).  

Были рассмотрены варианта сжатия ``Deflater``, ``PPMD`` и ``DataCompressor``, но ничто не дало должных результатов. 
От сюда можно сделать вывод, что rle и дельта, которая используются в jpeg, это неотъемлемая часть и нужно смотреть в сторону более эффективных энтропийных кодеров.
Также были рассмотрены методы последовательного кодирования коэффициентов, а не зигзагообразного, но тоже не дало результатов.
  
## Результаты  

Итоговые результаты ``GenericJpegCompressor``, который выбирает лучшую стратегию сжатия.

### Quality 30

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| airplane30.jpg | 19207 | 18849 | 1.864 |
| tulips30.jpg | 37972 | 37557 | 1.093 |
| serrano30.jpg | 58288 | 57164 | 1.928 |
| girl30.jpg | 24310 | 23229 | 4.447 |
| lena30.jpg | 17578 | 17441 | 0.779 |
| baboon30.jpg | 36113 | 35369 | 2.060 |
| cat30.jpg | 35902 | 35527 | 1.045 |
| sails30.jpg | 45512 | 44460 | 2.311 |
| monarch30.jpg | 28501 | 28228 | 0.958 |
| arctichare30.jpg | 12080 | 11444 | 5.265 |
| fruits30.jpg | 17646 | 17376 | 1.530 |
| frymire30.jpg | 200860 | 194598 | 3.118 |
| watch30.jpg | 46741 | 44310 | 5.201 |
| peppers30.jpg | 18746 | 18650 | 0.512 |
| pool30.jpg | 7467 | 6196 | 17.022 |
| total | 606923 | 590398 | 2.723 |

### Quality 80

| File name | Raw size(bytes) | Compressed size(bytes) | Ratio (%) |
| ----------- | ----------- | ----------- | ----------- |
| cat80.jpg | 81974 | 81421 | 0.675 |
| monarch80.jpg | 64055 | 64056 | -0.002 |
| tulips80.jpg | 85764 | 85441 | 0.377 |
| lena80.jpg | 43872 | 43861 | 0.025 |
| peppers80.jpg | 47929 | 47828 | 0.211 |
| serrano80.jpg | 138167 | 135522 | 1.914 |
| sails80.jpg | 105830 | 105760 | 0.066 |
| airplane80.jpg | 44079 | 44076 | 0.007 |
| baboon80.jpg | 88465 | 88304 | 0.182 |
| watch80.jpg | 101074 | 99902 | 1.160 |
| arctichare80.jpg | 26569 | 26271 | 1.122 |
| girl80.jpg | 59979 | 59644 | 0.559 |
| pool80.jpg | 14492 | 13804 | 4.747 |
| frymire80.jpg | 440857 | 431111 | 2.211 |
| fruits80.jpg | 45303 | 45304 | -0.002 |
| total | 1388409 | 1372305 | 1.160 |